---
title: "Effect of water, sanitation, and hygiene interventions on detection of enteropathogens and host-specific fecal markers in the environment: an individual-participant data meta-analysis"
author: "Andrew Mertens, Benjamin F. Arnold, Jade Benjamin-Chung, Alexandria Boehm, Joe Brown, Drew Capone, Thomas Clasen, Erica Fuhrmeister, Jessica Grembi, David Holcomb, Jackie Knee, Laura Kwong, Audrie Lin, Stephen P. Luby, Rassul Nala, Kara Nelson, Sammy Njenga, Clair Null, Amy J. Pickering, Mahbubur Rahman, Heather Reese, Lauren Steinbaum, Jill Stewart, Ruwan Thilakaratne, Oliver Cumming, John M. Colford Jr., Ayse Ercumen"
output: 
  word_document:
    reference_docx:  "tables_format.docx"
---


```{r, include=F}

#Note: Check out this package for integrating any edits from Ayse:
#https://github.com/noamross/redoc

#CSL styles by journal
#https://github.com/citation-style-language/styles


knitr::opts_chunk$set(echo = FALSE, dpi=300,fig.width=7)

options(warn = -1) 
library(tidyverse)
library(officedown)
library(janitor)
library(knitr)
library(here)
# library(table1)
# library(rvest)
library(officer)
library(flextable)
library(bibtex)
library(citr)
library(redoc)
source(here("0-config.R"))
#citr:::insert_citation(bib_file ="WASH-IPD.bib", use_betterbiblatex =F)
# 
# tidy_bib_file(
#   rmd_file = "Aim1_manuscript.Rmd"
#   , messy_bibliography = "WASH-IPD.bib"
#   , file = "tidy_references.bib"
# )



op = function(x, d=2) sprintf(paste0("%1.",d,"f"), x) 

Print <- function(x){
  prettyNum(round(x,2), big.mark = ",", scientific = FALSE)
}

 library(pander)
panderOptions('digits', 2)
panderOptions('round', 2)
panderOptions('keep.trailing.zeros', TRUE)
panderOptions('graph.fontsize', 8)

panderOptions('table.alignment.default', function(df)
    ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")

set_flextable_defaults(big.mark = ",", 
  font.size = 8, theme_fun = theme_vanilla,
  padding.bottom = 5, 
  padding.top = 5,
  padding.left = 5,
  padding.right = 5)

#load clean data
d <- readRDS(paste0(dropboxDir,"Data/cleaned_ipd_env_data.rds"))
#sample-positive specific dataset
pos <- d %>% filter(!grepl("Any",sample),!grepl("any",sample),!grepl("Any",target), !is.na(pos))
#aggregate samples
pos.agg <- d %>% filter(grepl("Any",sample),grepl("any",sample),grepl("Any",target), !is.na(pos))
#abundance dataset
abund <- d %>% filter(!grepl("Any",sample),!grepl("any",sample),!grepl("Any",target), !is.na(abund))

#number of samples by study
num_samples_by_study <- d %>% filter(!grepl("Any",sample),!grepl("any",sample),!grepl("Any",target), !is.na(pos)) %>% 
  group_by(study, sample, clusterid, dataid, round, sampleid) %>% slice(1) %>%
  group_by(study) %>%
  summarize(N=n()) %>% mutate(study=gsub(" et al.","",as.character(study))) %>% arrange(N)

#number of food prep samples 
FP <- d %>% filter(sample=="FP") %>% group_by(target)

#Load figures and tables
load(here("figures/all_tables.Rdata"))
S_tab1 <- read.csv(here("data/S_tab1_template.csv"))
colnames(S_tab1) <- c("Study design","WASH","Environmental markers", "Child health")

S_tab2 <- read.csv(here("data/S_tab2_template.csv"))
colnames(S_tab2) <- ""

# load(here("figures/agg_tables.Rdata"))
load(here("figures/abundance_tables.Rdata"))
#Drop low ROQ
tab_unadj_diff <- tab_unadj_diff %>% filter(`% in ROQ` >= 50)
tab_adj_diff <- tab_adj_diff %>% filter(`% in ROQ` >= 50)

load(here("figures/all_figures.Rdata"))
load(here("figures/subgroup_figures.Rdata"))
#load(here("figures/density_figures.Rdata"))
load(here("figures/outcome_groups.Rdata"))
load(here("figures/aim1_all_tables.Rdata"))


bias_tab <- readxl::read_excel(here("manuscripts/WASH_IPD_bias_assessment.xlsx"), sheet = "aim1")



adj_RR <- readRDS(file=here("results/adjusted_aim1_RR_pooled.Rds")) 
unadj_RR <- readRDS(file=here("results/unadjusted_aim1_RR_pooled.Rds")) 
adj_RR_agg <- adj_RR %>% filter(grepl("Any",sample)|grepl("Any",target))
unadj_RR_agg <- unadj_RR %>% filter(grepl("Any",sample)|grepl("Any",target))

pooled_adj_RR <- adj_RR %>% filter(study=="Pooled")
adj_RR <- adj_RR %>% filter(study!="Pooled")
adj_diff <- readRDS(file=here("results/adjusted_aim1_diff.Rds")) 
sig_diff <- adj_diff %>% ungroup() %>% filter(pval < 0.05, perc_ROQ >=50) %>% select(study, sample, target, coef, ci.lb, ci.ub, pval, perc_ROQ)

adj_emm <- readRDS(here("results/adjusted_aim1_emm.Rds"))
zoonotic_animals_RR <- readRDS(here("results/adjusted_zoonotic_animals.Rds"))

#Study-specific estimates
protective <- adj_RR %>% ungroup() %>% filter(!is.na(coef),RR<=1) %>% select(sample, target, RR, ci.lb, ci.ub, study)
n_protective <- paste0(round(nrow(protective)/nrow(adj_RR %>% filter(!is.na(coef))) * 100, 1),"% (",nrow(protective),"/",nrow(adj_RR %>% filter(!is.na(coef))),")")

sig <- adj_RR %>% ungroup() %>% filter(ci.lb<1 & ci.ub<1 | ci.lb>1 & ci.ub>1) %>% select(sample, target, RR, ci.lb, ci.ub, study)
n_per_sig <- paste0(round(nrow(sig)/nrow(adj_RR %>% filter(!is.na(coef))) * 100, 1),"% (",nrow(sig),"/",nrow(adj_RR %>% filter(!is.na(coef))),")")

perc_no_pos = round(prop.table(table((adj_RR$minN==0)))*100,1)[2]
num_no_pos = paste0(as.character(sum(adj_RR$minN==0, na.rm=T)),"/",as.character(nrow(adj_RR)))
adj_RR <- adj_RR %>% filter(minN!=0)
num_sparse_pos = paste0(as.character(sum(is.na(adj_RR$coef), na.rm=T)),"/",as.character(nrow(adj_RR)))
adj_sparse <- adj_RR %>% filter(is.na(coef)) %>% mutate(inv_n = N-n)
too_neg=round(mean(adj_sparse$n <= 10 | adj_sparse$a < 2 | adj_sparse$c < 2) * 100, 1)
too_pos=round(mean(adj_sparse$inv_n <= 10 | adj_sparse$b < 2 | adj_sparse$d < 2) * 100, 1)

MST_protect  <- adj_RR %>% filter(grepl("MST", target))
round(prop.table(table(MST_protect$RR<1))[2]*100,1)
#Pvalue adjustment
#min(p.adjust(adj_RR$pval, method="BH"), na.rm=T)

#difference between adjusted and unadjusted

d_unadj_comp<- left_join(adj_RR, unadj_RR, by=c("Y","sample","target","study"))
d_unadj_comp <- d_unadj_comp %>% mutate(log.diff= coef.x-coef.y, log.abs.diff=abs(coef.x-coef.y), diff= RR.x-RR.y, abs.diff=abs(RR.x-RR.y))
med_unadj_diff<-median(d_unadj_comp$log.abs.diff, na.rm=T)


#Clean results function
clean_est <- function(res, outcome="binomial"){
  if(outcome=="binomial"){
    est = round(res$RR, 2)
    ci.lb = round(res$ci.lb, 2) 
    ci.ub = round(res$ci.ub, 2)
    est.ci = paste0("RR=",est," (95% CI: ",ci.lb,", ",ci.ub,")")
  }else{
    est = round(res$coef, 2)
    ci.lb = round(res$ci.lb, 2) 
    ci.ub = round(res$ci.ub, 2)
    est.ci = paste0("difference= ",est," (95% CI: ",ci.lb,", ",ci.ub,")")
  }
  return(est.ci)
}

clean_res  <- function(res, outcome="binomial"){
  if(outcome=="binomial"){
    res$est.ci = paste0("PR=",round(as.numeric(res$RR),2)," (95% CI: ",round(res$ci.lb,2),", ",round(res$ci.ub,2),")")
    res <- res %>% ungroup() %>%
      select(study, sample_cat_f, target_f, est.ci, pval, a, b, c, d, N) 
    res$est.ci <- gsub("PR\\=1 \\(95\\% CI\\: NA, NA\\)","Not estimated",res$est.ci)
    
    res$pval <- as.character(round(res$pval,2))
    res$pval[is.na(res$pval)] <- ""
    res <- res %>% 
      rename(Study=study,
             Sample=sample_cat_f,
             Target=target_f,
             Estimate=est.ci,
             `p-value`=pval, 
             `Positive,\nIntervention`=a,
             `Negative,\nIntervention`=b,
             `Positive,\nControl`=c,
             `Negative,\nControl`=d,
             `Total\nobservations`=N)
  }else{
    res$est.ci = paste0("Difference=",round(as.numeric(res$coef),2)," (95% CI: ",round(res$ci.lb,2),", ",round(res$ci.ub,2),")")
    res <- res %>% ungroup() %>%
      select(sample_type, target_f, est.ci, pval, a, b, c, d, N) 
    res$est.ci <- gsub("Difference\\=0 \\(95\\% CI\\: NA, NA\\)","Not estimated",res$est.ci)
    res$pval <- as.character(round(res$pval,2))
    res$pval[is.na(res$pval)] <- ""
    res <- res %>% 
      rename(Study=study,
             Sample=sample_cat_f,
             Target=target_f,
             Estimate=est.ci,
             `p-value`=pval, 
             `Positive,\nIntervention`=a,
             `Negative,\nIntervention`=b,
             `Positive,\nControl`=c,
             `Negative,\nControl`=d,
             `Total obs-\nervations`=N)
  }
  return(res)
}

clean_res_tab <- function(unadj_RR, adj_RR){
  unadj<-clean_res(unadj_RR) %>% select(Study,Sample,Target,Estimate, `p-value`) %>% 
    rename(`Unadjusted\nPrevalence Ratio`=Estimate, `Unadjusted\np-value`=`p-value`) 
  adj<-clean_res(adj_RR)%>% rename(`Adjusted\nPrevalence Ratio`=Estimate, `Adjusted\np-value`=`p-value`)
  
  res <- left_join(unadj, adj, by=c("Study", "Target", "Sample"))
  res <- res %>% arrange(Study,  Target,  Sample) %>% filter(Study!="Pooled")
  res$`Adjusted\nPrevalence Ratio`[res$Study=="Odagiri 2016"] <- ""
  res$`Adjusted\np-value`[res$Study=="Odagiri 2016"] <- ""
  
  res <- res[,c(1,3,2, 8:12, 4:7)]
  return(res)
}

FitFlextableToPage_landscape <- function(ft, pgwidth = 10){

  ft_out <- ft %>% autofit()
  #ft_out <- set_caption(ft_out, "my caption")

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}





#adj_RR %>% filter(target=="Any virus", sample!="any sample type") %>% select(sample, target, RR, ci.lb, ci.ub, study, a,b,c,d) %>% arrange(sample) %>% as.data.frame()


```

```{css, echo=FALSE}
span.comment-start{
    background: #e0f3db;
}
span.comment-end{
    background: #e0f3db;
}
span.comment-start::after{
    content: " (" attr(author) ", " attr(date) ") [";
}
span.comment-end::before{
    content: "]"
}
span.comment-text{
    background: #fdbb84;
}


```

```{r, echo=FALSE}
commentN <- 0
cmt <- function(txt, cm, author, date = "2021-01-01", comN = commentN){
  cmt_str <- paste0('<span class="comment-text">[',cm,']{.comment-start id="', comN, '" author="', author, '" date="', date, '"}', txt, '[]{.comment-end id="',commentN,'"}</span>')
  assign("commentN", commentN + 1, envir = .GlobalEnv)
  return(cmt_str)
}
```

\newpage
   
   
# Supplementary Tables

## Table S1. Systematic review search terms
Search terms were combined with "OR" within columns and with "AND" across columns. 

```{r, echo=F, warning=F, message=F,  results = 'asis'}
FitFlextableToPage_landscape(flextable(S_tab1), pgwidth=8)
```


\newpage

## Table S2. Pubmed search string
[MH] are mesh headers and [TW] are text words.

```{r, echo=F, warning=F, message=F,  results = 'asis'}
knitr::kable(S_tab2)
```

\newpage


## Table S3. PRISMA Checklist
(See separate attachment)

\newpage


## Table S4. Risk of bias based on modified Newcastle-Ottawa scale
Stars are given for low risk of bias in each category, up to a total of nine stars. Scoring details are in the footnotes.

```{r, echo=F, warning=F, message=F,  results = 'asis'}
# autofit(flextable(target_presence_long_P))
# 
bias_tab_char <- bias_tab
bias_tab <- flextable(bias_tab)
bias_tab <- compose(bias_tab, part = "body", i = 1, j = 2, value = as_paragraph(as.character(bias_tab_char[1,2]), as_sup("a")))
bias_tab <- compose(bias_tab, part = "body", i = 1, j = 3, value = as_paragraph(as.character(bias_tab_char[1,3]), as_sup("b")))
bias_tab <- compose(bias_tab, part = "body", i = 1, j = 4, value = as_paragraph(as.character(bias_tab_char[1,4]), as_sup("c")))
bias_tab <- compose(bias_tab, part = "body", i = 1, j = 5, value = as_paragraph(as.character(bias_tab_char[1,5]), as_sup("d")))
bias_tab <- compose(bias_tab, part = "body", i = 1, j = 6, value = as_paragraph(as.character(bias_tab_char[1,6]), as_sup("e")))
bias_tab <- compose(bias_tab, part = "body", i = 1, j = 7, value = as_paragraph(as.character(bias_tab_char[1,7]), as_sup("f")))
bias_tab <- compose(bias_tab, part = "body", i = 1, j = 8, value = as_paragraph(as.character(bias_tab_char[1,8]), as_sup("g")))

FitFlextableToPage_landscape(bias_tab, pgwidth=10)

```


^a^ RCTs receive 1 star, unless evidence of selection bias (e.g. randomisation procedures not followed). Meaningful differences between groups at baseline in RCTs receive 0 stars. Rates of declining to participate >10% receive 0 stars. Non- or quasi-randomised studies receive 0 stars. 

^b^ If intervention recipient was not blinded to intervention status, 0 stars. 
 
^c^ <10% receives 1 star, greater than or equal to 10% receives 0 stars.
 
^d^ Interventions delivered at the household/individual level receive 1 star. Interventions delivered at the community level that missed a substantial, i.e. greater than or equal to 10%,  proportion of the target population receive 0 stars, including when there is insufficient information to verify whether this is the case. Interventions with substantial risk of contamination (control households receiving intervention) receive 0 stars.
 
^e^ Parent / person recall (=0 stars). Fieldworker assessed (=1 star). Physician/microbiologically assessed (=2 stars)
 
^f^ If outcome measurement staff were not blinded to intervention status, 0 stars.
 
^g^ Scoring is based on losing stars (max. 2). Individual RCTs with baseline balance on covariates are unlikely to require adjustment (=2 stars). Cluster-RCTs and non-randomised trials may require adjustment for clustering (-1 star if not done). RCTs or cRCTs may require adjustment for covariates, with justification (-1 star if not done). Non-randomised studies require adjustment for covariates (-1 star if not done), but also adequate justification for covariate selection (-1 star if not included), and there can be too few or too many covariates.

\newpage


## Table S5. Prevalence of pathogens by sample type tested in each study 

```{r, echo=F, warning=F, message=F,  results = 'asis'}
# autofit(flextable(target_presence_long_P))
# 
FitFlextableToPage_landscape(flextable(target_presence_long_P), pgwidth=8)

```

\newpage


## Table S6. Prevalence of microbial source tracking markers by sample type tested in each study

```{r, echo=F,  results = 'asis'}
# autofit(flextable(target_presence_long_MST))
#target_presence_long_MST <- target_presence_long_MST  %>% flextable(theme_fun = theme_box)

FitFlextableToPage_landscape(flextable(target_presence_long_MST), pgwidth=8)

```


\newpage


## Table S7.

Unadjusted and adjusted results by study, sample type, and aggregated variables for pathogen targets (any pathogen, any bacteria, any viruses, any protozoa, any STH).

```{r, echo=F, results = 'asis'}

tabs7 <- clean_res_tab(unadj_RR_agg,adj_RR_agg)
#Drop any sample type from studies with only one sample type
tabs7 <- tabs7 %>% filter(!(Study=="Kwong 2021" & Sample=="Any sample"), !(Study=="Steinbaum 2021" & Sample=="Any sample"), !(Study=="Kwong 2021" & Target=="Any pathogen"), !(Study=="Steinbaum 2021" & Target=="Any pathogen"), !(Study=="Reese 2017" & Target=="Any pathogen")) %>% 
  mutate(Sample=factor(Sample, levels = c(
    "Any sample","Source water","Stored water",
    "Child hands","Mother's hands", 
    "House soil", "Latrine soil",
    "Flies in latrine",  "Flies in kitchen"
  )))

tabs7_pathogen <- tabs7 %>% filter(!grepl("MST",Target)) %>% droplevels() %>%
  arrange(Target, Sample)


FitFlextableToPage_landscape(flextable(tabs7_pathogen))
```

\newpage


## Table S8.

Unadjusted and adjusted results by study, sample type, and aggregated variables for MST targets (any MST, any general MST, any human MST, any animal MST).

```{r, echo=F, results = 'asis'}

tabs7_MST <- tabs7 %>% filter(grepl("MST",Target)) %>% droplevels() %>%
  arrange(Target, Sample)

FitFlextableToPage_landscape(flextable(tabs7_MST))
```

\newpage


## Table S9.


Baseline covariates by study. Note that Odigari et al. 2016 is not included as data shared from this study were from village water sources and did not have associated covariates from individual households; therefore all estimates for this study are unadjusted.


```{r, echo=F, results = 'asis'}
FitFlextableToPage_landscape(flextable(tab2), pgwidth=8)
```

